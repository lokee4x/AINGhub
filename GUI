-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Create GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 200, 0, 100)
MainFrame.Position = UDim2.new(0.5, -100, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
MainFrame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0.3, 0)
Title.BackgroundTransparency = 1
Title.Text = "AING ESP"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextScaled = true
Title.Parent = MainFrame

local ESPButton = Instance.new("TextButton")
ESPButton.Size = UDim2.new(0.8, 0, 0.4, 0)
ESPButton.Position = UDim2.new(0.1, 0, 0.5, 0)
ESPButton.Text = "ESP: OFF"
ESPButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
ESPButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPButton.Parent = MainFrame

-- ESP Functionality
local espEnabled = false
local espCache = {}

local function getCharacterPrimaryPart(character)
    return character:FindFirstChild("HumanoidRootPart") or character:FindFirstChildWhichIsA("BasePart")
end

local function createOrUpdateESP(character)
    local primaryPart = getCharacterPrimaryPart(character)
    if not primaryPart then return end

    local billboard = espCache[character]
    if not billboard then
        billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP"
        billboard.Size = UDim2.new(0, 100, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        
        local nameLabel = Instance.new("TextLabel", billboard)
        nameLabel.Size = UDim2.new(1, 0, 1, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        nameLabel.TextScaled = true
        nameLabel.Text = character.Name

        billboard.Parent = primaryPart
        billboard.Adornee = primaryPart
        espCache[character] = billboard
    else
        billboard.Adornee = primaryPart
    end
end

local function removeESP(character)
    local billboard = espCache[character]
    if billboard then
        billboard:Destroy()
        espCache[character] = nil
    end
end

local function applyESPToAllCharacters()
    for _, descendant in pairs(workspace:GetDescendants()) do
        if descendant:IsA("Model") and descendant:FindFirstChildOfClass("Humanoid") then
            createOrUpdateESP(descendant)
        end
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    ESPButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    ESPButton.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    
    if espEnabled then
        applyESPToAllCharacters()
    else
        for character, _ in pairs(espCache) do
            removeESP(character)
        end
    end
end

ESPButton.MouseButton1Click:Connect(toggleESP)

-- Character and NPC Tracking
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        if espEnabled then
            createOrUpdateESP(character)
        end
    end)
end)

Workspace.DescendantAdded:Connect(function(descendant)
    if descendant:IsA("Model") and descendant:FindFirstChildOfClass("Humanoid") and espEnabled then
        createOrUpdateESP(descendant)
    end
end)

Workspace.DescendantRemoving:Connect(function(descendant)
    if descendant:IsA("Model") then
        removeESP(descendant)
    end
end)
