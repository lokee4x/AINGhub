-- GUI Sederhana dengan Title di Tengah & Close Button
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local CloseButton = Instance.new("TextButton")
local TitleLabel = Instance.new("TextLabel")

ScreenGui.Parent = game.CoreGui
Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0, 300, 0, 50)
Frame.Position = UDim2.new(0.5, -150, 0.1, 0)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 2
Frame.Active = true
Frame.Draggable = true

-- Title di Tengah
TitleLabel.Parent = Frame
TitleLabel.Size = UDim2.new(1, -40, 1, 0)
TitleLabel.Position = UDim2.new(0, 0, 0, 0)
TitleLabel.Text = "NPC or Die ESP"
TitleLabel.TextSize = 18
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.Font = Enum.Font.SourceSansBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Center
TitleLabel.TextYAlignment = Enum.TextYAlignment.Center

-- Close Button di Pojok Kanan
CloseButton.Parent = Frame
CloseButton.Size = UDim2.new(0, 30, 1, 0)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.Text = "X"
CloseButton.TextSize = 18
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    print("[❌] GUI Ditutup.")
end)

print("[✅] GUI Dibuka & ESP Aktif!")

-- === ESP SYSTEM ===
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local BlockedPlayers = {} -- Menyimpan pemain yang sudah diberi ESP

-- Fungsi untuk membuat ESP Box
local function createESP(player)
    -- Cek apakah karakter benar-benar pemain asli, bukan NPC/Ragdoll
    if Players:GetPlayerFromCharacter(player.Character) then
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local box = Instance.new("BoxHandleAdornment")
            box.Size = Vector3.new(4, 6, 4)
            box.Adornee = player.Character.HumanoidRootPart
            box.Color3 = Color3.fromRGB(0, 255, 0) -- Warna hijau untuk pemain normal
            box.Transparency = 0.5
            box.ZIndex = 5
            box.AlwaysOnTop = true
            box.Parent = player.Character.HumanoidRootPart -- Parent ke karakter pemain
            return box
        end
    end
end

-- Tambahkan ESP hanya untuk pemain asli
local function addPlayerESP(player)
    if not BlockedPlayers[player.UserId] then
        local esp = createESP(player)
        if esp then
            BlockedPlayers[player.UserId] = esp
        end
    end
end

-- Hapus ESP jika pemain keluar dari game
local function removePlayerESP(player)
    if BlockedPlayers[player.UserId] then
        BlockedPlayers[player.UserId]:Destroy()
        BlockedPlayers[player.UserId] = nil
    end
end

-- Tambahkan ESP untuk semua pemain yang ada saat script dijalankan
for _, player in pairs(Players:GetPlayers()) do
    addPlayerESP(player)
end

-- Event listener untuk pemain yang baru join
Players.PlayerAdded:Connect(function(player)
    addPlayerESP(player)
end)

-- Event listener untuk pemain yang keluar
Players.PlayerRemoving:Connect(function(player)
    removePlayerESP(player)
end)

-- Update ESP setiap frame agar tetap mengikuti pemain
RunService.RenderStepped:Connect(function()
    for userId, esp in pairs(BlockedPlayers) do
        local player = Players:GetPlayerByUserId(userId)
        if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and esp.Parent then
            esp.Adornee = player.Character.HumanoidRootPart
        end
    end
end)

print("[✅] ESP Siap Digunakan! Hanya Pemain Asli yang Terlihat.")
